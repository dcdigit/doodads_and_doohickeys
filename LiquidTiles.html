<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precision Goo Architect</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
    <style>
        body {
            margin: 0;
            background-color: #050505;
            color: #ccc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 310px;
            background: #111;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border-right: 1px solid #333;
            overflow-y: auto;
            flex-shrink: 0;
            box-shadow: 5px 0 15px rgba(0,0,0,0.5);
            z-index: 10;
        }

        h2 { margin: 0 0 5px 0; color: #fff; font-size: 1.1rem; letter-spacing: 1px; }
        .section-title { 
            font-size: 0.7rem; 
            color: #888; 
            text-transform: uppercase; 
            margin-top: 8px; 
            border-bottom: 1px solid #333; 
            padding-bottom: 4px;
            font-weight: bold;
        }

        .control-group { display: flex; flex-direction: column; gap: 5px; }
        
        /* Flex row for side-by-side inputs */
        .row-inputs { display: flex; gap: 10px; }
        .input-wrapper { display: flex; flex-direction: column; flex: 1; }
        
        /* Text/Number Inputs */
        input[type=number] {
            background: #222;
            border: 1px solid #444;
            color: #fff;
            padding: 6px;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box; 
            font-family: monospace;
        }
        input[type=number]:focus { border-color: #00ff88; outline: none; }

        label {
            font-size: 0.75rem;
            display: flex;
            justify-content: space-between;
            color: #aaa;
        }

        /* Sliders */
        input[type=range] {
            width: 100%;
            height: 4px;
            background: #333;
            appearance: none;
            outline: none;
            opacity: 0.8;
            border-radius: 2px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #00ff88;
            cursor: pointer;
            border-radius: 50%;
        }

        /* Checkboxes */
        .checkbox-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 5px;}
        .checkbox-item { display: flex; align-items: center; font-size: 0.8rem; gap: 5px; cursor: pointer; }
        input[type=checkbox] { accent-color: #00ff88; transform: scale(1.1); }

        /* Buttons */
        button {
            padding: 10px;
            background: #222;
            color: white;
            border: 1px solid #444;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.75rem;
            border-radius: 4px;
            transition: 0.2s;
            margin-top: 5px;
        }
        button:hover { background: #00ff88; color: #000; border-color: #00ff88; }
        button.primary { background: #00ff88; color: #000; border: none; }
        button.primary:hover { background: #fff; }

        /* --- CANVAS AREA --- */
        #canvas-wrapper {
            flex-grow: 1;
            background-color: #080808;
            background-image: 
                linear-gradient(#151515 1px, transparent 1px),
                linear-gradient(90deg, #151515 1px, transparent 1px);
            background-size: 40px 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            overflow: hidden;
        }

        canvas {
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border: 1px solid #333;
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>Goo Architect</h2>
        
        <div class="section-title">Canvas Size (px)</div>
        <div class="row-inputs">
            <div class="input-wrapper">
                <label>Width</label>
                <input type="number" id="tileW" value="800">
            </div>
            <div class="input-wrapper">
                <label>Height</label>
                <input type="number" id="tileH" value="800">
            </div>
        </div>
        <button onclick="updateDimensions()">Set Dimensions</button>

        <div class="section-title">Grid Layout</div>
        <div class="row-inputs">
            <div class="input-wrapper">
                <label>Columns</label>
                <input type="number" id="gridCols" value="8">
            </div>
            <div class="input-wrapper">
                <label>Rows</label>
                <input type="number" id="gridRows" value="8">
            </div>
        </div>
        <div class="control-group">
            <label>Position Jitter (Chaos)</label>
            <input type="range" id="jitterSlider" min="0" max="100" value="10">
        </div>

        <div class="section-title">Shape Size (px)</div>
        <div class="control-group">
            <label>Minimum Size</label>
            <input type="range" id="minSizeSlider" min="5" max="400" value="40">
        </div>
        <div class="control-group">
            <label>Maximum Size</label>
            <input type="range" id="maxSizeSlider" min="5" max="400" value="120">
        </div>

        <div class="section-title">Geometry</div>
        <div class="checkbox-group">
            <label class="checkbox-item"><input type="checkbox" id="chkSquare" checked> Square</label>
            <label class="checkbox-item"><input type="checkbox" id="chkCircle" checked> Circle</label>
            <label class="checkbox-item"><input type="checkbox" id="chkTri"> Tri</label>
        </div>
        <div class="control-group" style="margin-top:10px;">
            <label>Rotation Variance</label>
            <input type="range" id="rotSlider" min="0" max="1" step="0.01" value="0.5">
        </div>

        <div class="section-title">Style</div>
        <div class="control-group">
            <label>Hollow Chance %</label>
            <input type="range" id="hollowSlider" min="0" max="1" step="0.05" value="0.0">
        </div>
        <div class="control-group">
            <label>Outline Thickness</label>
            <input type="range" id="strokeSlider" min="1" max="50" value="10">
        </div>

        <div class="section-title">The "Goo"</div>
        <div class="control-group">
            <label>Melt Radius (Blur)</label>
            <input type="range" id="meltSlider" min="0" max="100" value="30">
        </div>
        <div class="control-group">
            <label>Threshold (Solidify)</label>
            <input type="range" id="threshSlider" min="0.01" max="0.99" step="0.01" value="0.5">
        </div>

        <div class="control-group">
            <label>Color</label>
            <input type="color" id="colorPicker" value="#00ff88" style="height:30px; width: 100%">
        </div>
        
        <button class="primary" onclick="generate()">Regenerate Grid</button>
        <button onclick="saveArt()">Save Tile Image</button>
    </div>

    <div id="canvas-wrapper">
        <div id="canvas-container"></div>
    </div>

    <script>
        let buffer;
        let shapes = [];
        
        // Canvas dimensions
        let tWidth = 800;
        let tHeight = 800;

        function setup() {
            let cnv = createCanvas(tWidth, tHeight);
            cnv.parent('canvas-container');
            
            // Initialize buffer
            buffer = createGraphics(tWidth, tHeight);
            
            generate();
        }

        // Called when user clicks "Set Dimensions"
        function updateDimensions() {
            let wInput = parseInt(select('#tileW').value());
            let hInput = parseInt(select('#tileH').value());
            
            if(wInput && hInput) {
                tWidth = wInput;
                tHeight = hInput;
                resizeCanvas(tWidth, tHeight);
                buffer = createGraphics(tWidth, tHeight);
                generate();
            }
        }

        function generate() {
            shapes = [];
            
            // Grid Inputs
            let cols = parseInt(select('#gridCols').value()) || 1;
            let rows = parseInt(select('#gridRows').value()) || 1;
            let jitter = parseInt(select('#jitterSlider').value());

            // Size Inputs
            let minS = parseInt(select('#minSizeSlider').value());
            let maxS = parseInt(select('#maxSizeSlider').value());
            
            // Ensure min isn't larger than max
            if (minS > maxS) [minS, maxS] = [maxS, minS];

            // Geometry & Style Inputs
            let rotChaos = parseFloat(select('#rotSlider').value());
            let hollowChance = parseFloat(select('#hollowSlider').value());
            let strokeThick = parseInt(select('#strokeSlider').value());
            
            // Active Shapes
            let types = [];
            if(select('#chkSquare').checked()) types.push('rect');
            if(select('#chkCircle').checked()) types.push('circle');
            if(select('#chkTri').checked()) types.push('tri');
            if(types.length === 0) types.push('rect');

            // --- GRID GENERATION ---
            let cellW = width / cols;
            let cellH = height / rows;

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    
                    // Base Center Position
                    let baseX = c * cellW + (cellW / 2);
                    let baseY = r * cellH + (cellH / 2);

                    // Add Jitter
                    let x = baseX + random(-jitter, jitter);
                    let y = baseY + random(-jitter, jitter);

                    // Determine Size
                    let s = random(minS, maxS);
                    let w = s;
                    let h = s;

                    // Aspect Ratio Variance (Only for rects/tris mostly)
                    if (rotChaos > 0.3 && types.includes('rect') && random() > 0.5) {
                        if (random() > 0.5) w *= random(0.6, 1.4);
                        else h *= random(0.6, 1.4);
                    }

                    shapes.push({
                        x: x, 
                        y: y,
                        w: w,
                        h: h,
                        type: random(types),
                        angle: random(-PI * rotChaos, PI * rotChaos),
                        isHollow: random() < hollowChance,
                        stroke: strokeThick
                    });
                }
            }
        }

        function draw() {
            // 1. Prepare Buffer (Black Background)
            buffer.background(0);
            
            // 2. Set "Goo" Settings
            let melt = parseInt(select('#meltSlider').value());
            buffer.drawingContext.shadowColor = 'white';
            buffer.drawingContext.shadowBlur = melt;
            
            // 3. Draw Shapes
            buffer.fill(255);
            buffer.noStroke();

            for(let s of shapes) {
                if (s.isHollow) {
                    buffer.noFill();
                    buffer.stroke(255);
                    buffer.strokeWeight(s.stroke);
                } else {
                    buffer.fill(255);
                    buffer.noStroke();
                }
                drawSeamless(s);
            }

            // 4. Threshold Filter (The Magic Step)
            let img = buffer.get();
            let thresh = parseFloat(select('#threshSlider').value());
            img.filter(THRESHOLD, thresh);

            // 5. Render to Screen
            background(20);
            let c = color(select('#colorPicker').value());
            tint(c);
            image(img, 0, 0, width, height);
            noTint();
        }

        // Tiling Logic
        function drawSeamless(s) {
            // Draw 9 times to ensure wrapping
            for (let dx = -1; dx <= 1; dx++) {
                for (let dy = -1; dy <= 1; dy++) {
                    buffer.push();
                    buffer.translate(s.x + (dx * width), s.y + (dy * height));
                    buffer.rotate(s.angle);

                    if (s.type === 'rect') {
                        buffer.rectMode(CENTER);
                        buffer.rect(0, 0, s.w, s.h);
                    } 
                    else if (s.type === 'circle') {
                        buffer.ellipse(0, 0, s.w, s.h);
                    } 
                    else if (s.type === 'tri') {
                        let r = s.w / 2;
                        // Equilateral triangle math
                        let x1 = 0; let y1 = -r;
                        let x2 = r * 0.866; let y2 = r * 0.5;
                        let x3 = -r * 0.866; let y3 = r * 0.5;
                        buffer.triangle(x1, y1, x2, y2, x3, y3);
                    }
                    buffer.pop();
                }
            }
        }

        function saveArt() {
            saveCanvas('gooey_grid_' + width + 'x' + height, 'png');
        }
    </script>
</body>
</html>